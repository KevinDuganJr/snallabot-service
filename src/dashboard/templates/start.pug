doctype html
html
  head
    meta(name="viewport" content="width=device-width, initial-scale=1")
    title Snallabot — Setup
    link(rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossOrigin="anonymous")
  body
    .container.py-4
      .row
        .col-md-8.mx-auto
          .card.shadow-sm
            .card-header.bg-white
              h4.mb-0 Connect Snallabot to EA (one-time setup)
            .card-body
              .alert.alert-info
                strong Please read before continuing:
                |  This setup links Snallabot to your EA account and your Madden league. Snallabot does NOT store your EA or console credentials (PSN, Xbox, etc.). It uses secure tokens to maintain the connection.
              p.mb-0
                | Follow these steps:
              ol.mt-2
                li Click the "Login to EA" button → this opens the EA login page in a new tab.
                li After signing in you may see a blank or error page and your browser URL will be at: 
                  code.ms-2 http://127.0.0.1
                  | → this is expected.
                li Copy the entire URL from your browser (the address bar) and paste it into the box below, then submit.
              hr
              p.small.text-muted.mb-2
                | Legally this falls under interoperability → this tool only automates a standard login flow.
              a.btn.btn-outline-primary.me-2(href=url target="_blank" rel="noopener") Login to EA
              form.d-inline(action="/dashboard/retrievePersonas" method="POST")
                .mb-3
                  label.form-label(for="code") Paste the URL shown in your browser (must start with "http://127.0.0.1")
                  .input-group
                    input#code.form-control(type="text" name="code" placeholder="e.g. http://127.0.0.1:PORT/..." aria-label="Redirect URL" value="")
                    button.btn.btn-secondary(type="button" id="pasteBtn") Paste
                  if discord
                    input#discord(type="hidden" name="discord" value=discord readonly=true)
                  .form-text.text-muted.mt-1
                    | Tip: copy the full URL from the browser address bar and paste it here. The form will enable the Next button when the URL looks valid.
                button#submit.btn.btn-success(type="submit" disabled=true) Continue to Next Step
    script.
      (function () {
        const inputElement = document.getElementById('code')
        const btn = document.getElementById('submit')
        const pasteBtn = document.getElementById('pasteBtn')

        function looksLikeLocalRedirect(val) {
          if (!val) return false
          const v = val.trim()
          return v.startsWith('http://127.0.0.1') || v.startsWith('127.0.0.1')
        }

        inputElement.addEventListener('input', function () { btn.disabled = !looksLikeLocalRedirect(this.value) })

        // convenience: try to read from clipboard (user gesture required in some browsers)
        pasteBtn.addEventListener('click', async function () {
          try {
            const text = await navigator.clipboard.readText()
            if (text) {
              inputElement.value = text
              inputElement.dispatchEvent(new Event('input', { bubbles: true }))
            }
          } catch (e) {
            // fallback: focus the field so the user can paste manually
            inputElement.focus()
          }
        })
      })()