doctype html
html
  head
    title Snallabot Dashboard
    link(rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossOrigin="anonymous")
    link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3.3/sandstone/bootstrap.min.css" crossorigin="anonymous" referrerpolicy="no-referrer")
    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossOrigin="anonymous")
  body
    .container-fluid.mt-2
      .row.mb-3
        .col-12
          .d-flex.justify-content-between.align-items-center
            h4.mb-0 #{leagueName} Snallabot Dashboard
            .text-end
              span.badge.bg-secondary #{seasonWeekType}
              span.ms-2.badge.bg-info Year #{seasonInfo.calendarYear}
              span.ms-2.badge.bg-light.text-dark Current Week: #{seasonInfo.weekTitle} #{seasonInfo.displayWeek > 0 ? seasonInfo.displayWeek : ''}
              span.ms-2.small.text-muted.d-block Last Advance: #{lastAdvance.toDateString()}
      .row.g-3
        .col-lg-4
          .card.h-100
            .card-body
              h5.card-title.mb-3 League Summary
              dl.row
                dt.col-5 Season
                dd.col-7 #{seasonWeekType}
                dt.col-5 Year
                dd.col-7 #{seasonInfo.calendarYear}
                dt.col-5 Current Week
                dd.col-7 #{seasonInfo.weekTitle} #{seasonInfo.displayWeek > 0 ? seasonInfo.displayWeek : ''}
                dt.col-5 Last Advance
                dd.col-7 #{lastAdvance.toDateString()}
              hr
              p.mb-0.text-muted Small UI controls are below — exports and schedule actions.
        .col-lg-5
          .card.h-100
            .card-header.d-flex.justify-content-between.align-items-center
              strong.mb-0 Export Controls
              small.text-muted Choose and run exports
            .card-body
              .row.g-2.align-items-center
                .col-md
                  .input-group
                    select.form-select#exportSelect
                      each key in Object.keys(exportOptions)
                        option(value=key) #{key}
                    button.btn.btn-primary#exportBtn(type="button") Export
                .col-md-auto
                  #exportFeedback
              hr
              .table-responsive.mt-2
                table.table.table-hover.table-sm.caption-top
                  caption.mb-2 List of Export Url's
                  thead.table-light
                    tr
                      th Url
                      th.text-center League Info
                      th.text-center Weekly Stats
                      th.text-center Roster
                      th.text-center Extra Data
                      th.text-center Auto Update
                      th.text-center
                        button#addExportBtn.btn.btn-success.btn-sm(type="button") Add Export Url
                  tbody#exportTableBody
                    each exportDestination in exports
                      tr
                        td(class="export-url") #{exportDestination.url}
                        td.text-center
                          input(type="checkbox", disabled=true, checked=exportDestination.leagueInfo )
                        td.text-center
                          input(type="checkbox", disabled=true, checked=exportDestination.weeklyStats)
                        td.text-center
                          input(type="checkbox", disabled=true, checked=exportDestination.rosters)
                        td.text-center
                          input(type="checkbox", disabled=true, checked=exportDestination.extraData)
                        td.text-center
                          input(type="checkbox", disabled=true, checked=exportDestination.autoUpdate)
                        td.text-center
                          if exportDestination.editable
                            button.btn.btn-outline-danger.btn-sm.remove-export-btn(type="button") Remove
        .col-lg-3
          .card.h-100
            .card-body.text-center
              h6.card-title Actions
              p.mb-3.text-muted Manage league connections and quick actions.
              button.btn.btn-danger#unlinkBtn(type="button") Unlink League
              br
              - const leagueIdForHref = (typeof leagueInfo !== 'undefined' && leagueInfo && leagueInfo.leagueId) ? leagueInfo.leagueId : ''
              a.btn.btn-outline-secondary.mt-2(href='/dashboard/league/' + leagueIdForHref) Open League Page
      .row.mt-3
        .col-12
          .card
            .card-header
              strong.mb-0 Schedule
              small.ms-2.text-muted Schedule for #{seasonInfo.weekTitle} #{seasonInfo.displayWeek > 0 ? seasonInfo.displayWeek : ''}
            .card-body.p-0
              .table-responsive
                table.table.table-hover.table-condensed.mb-0
                  thead.table-light
                    tr
                      th Game
                      th Result
                      th Number of Times Played
                  tbody
                    each seasonGame in gameScheduleHubInfo.leagueSchedule
                      - const game = seasonGame.seasonGameInfo
                      tr
                        td #{game.isAwayHuman ? game.awayUserName : 'CPU'} #{game.awayCityName} #{game.awayName} (#{game.awayWin} - #{game.awayLoss}#{game.awayTie > 0 ? ' - ' + game.awayTie : ''}) at #{game.isHomeHuman ? game.homeUserName : 'CPU'} #{game.homeCityName} #{game.homeName} (#{game.homeWin} - #{game.homeLoss}#{game.homeTie > 0 ? ' - ' + game.homeTie : ''})
                        td #{game.result || 'Not Played'}
                        td #{game.numberTimesPlayed || 0}
    // keep original scripts intact (IDs/classes preserved)
    script.
      document.getElementById('addExportBtn').addEventListener('click', function () {
      const tableBody = document.getElementById('exportTableBody');
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td><input type="text" class="form-control url-input" placeholder="Enter URL"></td>
        <td style="text-align: center;"><input class="leagueInfo" type="checkbox"></td>
        <td style="text-align: center;"><input class="weeklyStats" type="checkbox"></td>
        <td style="text-align: center;"><input class="rosters" type="checkbox"></td>
        <td style="text-align: center;"><input class="extraData" type="checkbox"></td>
        <td style="text-align: center;"><input class="autoUpdate" type="checkbox"></td>
        <td style="text-align: center;">
          <button class="add-export-btn btn btn-outline-primary btn-sm">Add</button>
        </td>
      `;
      tableBody.appendChild(newRow);
      newRow.querySelector('.add-export-btn').addEventListener('click', async function () {
      const url = newRow.querySelector('.url-input').value;
      const leagueInfo = newRow.querySelector('.leagueInfo').checked;
      const weeklyStats = newRow.querySelector('.weeklyStats').checked;
      const rosters = newRow.querySelector('.rosters').checked;
      const extraData = newRow.querySelector('.extraData').checked;
      const autoUpdate = newRow.querySelector('.autoUpdate').checked;
    
      try {
        const response = await fetch(window.location.pathname + '/updateExport', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            url,
            leagueInfo,
            weeklyStats,
            rosters,
            extraData,
            autoUpdate,
            editable: true,
          })
        });
        location.reload()
      } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while adding the export URL.');
      }
      });
      })
      document.querySelectorAll('.remove-export-btn').forEach(btn => {
      btn.addEventListener('click', async function () {
        const row = this.closest('tr');
        const urlCell = row.querySelector('.export-url');
        const url = urlCell.textContent.trim();
    
        try {
          const response = await fetch(window.location.pathname + '/deleteExport', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({url})
          });
    
          if (response.ok) {
            location.reload();
          } else {
            alert('Failed to remove export URL.');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('An error occurred while removing the export URL.');
        }
      });
      });
      document.getElementById('exportBtn').addEventListener('click', async function () {
      const selectedOption = document.getElementById('exportSelect').value;
    
      try {
        const feedbackDiv = document.getElementById('exportFeedback');
        feedbackDiv.innerHTML = '';
    
        const badge = document.createElement('span');
        badge.className = "badge text-bg-info"
        badge.textContent = "Exporting..."
        feedbackDiv.appendChild(badge);
        const response = await fetch(window.location.pathname + '/export', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ exportOption: selectedOption })
        });
        feedbackDiv.innerHTML = '';
    
        const responseBadge = document.createElement('span');
        responseBadge.className = response.ok
          ? 'badge text-bg-success'
          : 'badge text-bg-danger';
        responseBadge.textContent = response.ok ? 'Export Successful :)' : 'Export failed :(';
    
        feedbackDiv.appendChild(responseBadge);
      } catch (error) {
        console.error('Error exporting:', error);
        alert('An error occurred while exporting.');
      }
      });
    
      document.getElementById('unlinkBtn').addEventListener('click', async function () {
        try {
          const response = await fetch(window.location.pathname + '/unlink', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });
    
          if (response.ok) {
            window.location.href = '/dashboard';
          } else {
            alert('Failed to unlink league.');
          }
        } catch (error) {
          console.error('Error unlinking league:', error);
          alert('An error occurred while unlinking the league.');
        }
      });